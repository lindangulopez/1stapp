<!DOCTYPE html>
<html>
<!-- source simpleImage() -->
 <script
 src="http://www.dukelearntoprogram.com/course1/common/js/image/SimpleImage.js" >
</script>
<head>
  <meta charset="utf-8">
  <title>Image Filters &amp; Treatments</title>
<style type="text/css">

html {border: 2px solid lightsalmon;
  margin-left: 100px;
  color: lightsalmon;
  text-align: center;
  background-color: lightyellow;
  font-family: Calibri,Candara,Segoe,"Segoe UI",Optima,Arial,sans-serif;
  margin: 15px;
}


h1, h2{color: hotpink;
  font-family: "Times New Roman", Times, serif;
}



header , footer{background-color: lightgray;
	border: 2px dotted hotpink;
  color: hotpink;
  font-family: "Times New Roman", Times, serif;
  box-shadow: 0 2px 10px -2px rgba(0, 0, 0, .5);
}

canvas{  border: 2px dotted hotpink;
  height: 70%;
  width: 50%;
  margin: 10px;
  float: center;
  background-color: white;
  box-shadow: 0 2px 10px -2px rgba(0, 0, 0, .5);
}

#t{
  font-size: 10px;
}
.preview{color: lightseagreen;
  }

.controls {
  color: color:lightsalmon;
}

.download{color: lightseagreen;
}

</style>
<body>

</head>
<header>
Image Preview - Filters - Treatment App:
</header>
  <main>

<div class="preview">

  <p>
    Check the type and dimensions of any image:

<input type="file" id="file" multiple onchange="checkFileDetails()" />
    <p id="fileInfo"></p>
  </p>
</div>
<p>
    <h1>
  Upload and preview your image:
    </h1>
</p>

<p>
<input type = "file" multiple = "false" accept = "image/*" id = "finput"
onchange = "loadImage()">
</p>

<canvas id="can" ></canvas>
<p class="download">
  ... download image, by right clicking ...
</p>

      <!-- heading  -->
</main>

<!-- subheadings -->
 <h1>
  Choose your Filter
</h1>
  <input type = "button" value = "Gray" onclick = "doGray()">
  <input type = "button" value = "Red" onclick = "doRed()">
  <input type = "button" value = "Blue" onclick = "doBlue()">
  <input type = "button" value = "Rainbow" onclick = "doRainbow()">
</p>

<p>
  <input type = "button" value = "Reset" onclick = "makeReset()">
</p>

<h2>
  Here is a more advanced image treatment,
</h2>
<p></p>
<div class="controls">
  <div class="line selection">Example, <label class="customWrapper"> upload your image: <input type="file" id="custom"></label></div>
  <label class="line">
    <span>Interval:</span><input type="range" id="interval" min="20" max="1000" value="300" step="10">
  </label>
  <label class="line">
    <span>Speed:</span><input type="range" id="speed" min="20" max="500" value="100" step="5">
  </label>
  <label class="line">
    <span>Speed factor:</span><input type="range" id="sf" min="1" max="50" value="15">
  </label>
</div>
<canvas id="c" width="400" height="400"></canvas>
<p class="download">
  ... download image, by right clicking ...
</p>
</body>

<footer> HTML-CSS-Javascript</footer>
<script type="text/javascript">

function makeGray(){
  for(var pix of img.values()){
    var a=((pix.getRed()+pix.getGreen()+pix.getBlue())/3);
    pix.setRed(a);
    pix.setGreen(a);
    pix.setBlue(a);
}
  var c=document.getElementById("c");
  img.drawTo(c);
}

function checkFileDetails() {
        var fi = document.getElementById('file');
        if (fi.files.length > 0) {      // FIRST CHECK IF ANY FILE IS SELECTED.

            for (var i = 0; i <= fi.files.length - 1; i++) {
                var fileName, fileExtension, fileSize, fileType, dateModified;

                // FILE NAME AND EXTENSION.
                fileName = fi.files.item(i).name;
                fileExtension = fileName.replace(/^.*\./, '');

                // CHECK IF ITS AN IMAGE FILE.
                // TO GET THE IMAGE WIDTH AND HEIGHT, WE'LL USE fileReader().
                if (fileExtension == 'png' || fileExtension == 'jpg' || fileExtension == 'jpeg') {
                   readImageFile(fi.files.item(i));             // GET IMAGE INFO USING fileReader().
                }
                else {
                    // IF THE FILE IS NOT AN IMAGE.

                    fileSize = fi.files.item(i).size;  // FILE SIZE.
                    fileType = fi.files.item(i).type;  // FILE TYPE.
                    dateModified = fi.files.item(i).lastModifiedDate;  // FILE LAST MODIFIED.

                    document.getElementById('fileInfo').innerHTML =
                        document.getElementById('fileInfo').innerHTML + '<br /> ' +
                            'Name: <b>' + fileName + '</b> <br />' +
                            'File Extension: <b>' + fileExtension + '</b> <br />' +
                            'Size: <b>' + Math.round((fileSize / 1024)) + '</b> KB <br />' +
                            'Type: <b>' + fileType + '</b> <br />' +
                            'Last Modified: <b>' + dateModified + '</b> <br />';
                }
            }

            // GET THE IMAGE WIDTH AND HEIGHT USING fileReader() API.
            function readImageFile(file) {
                var reader = new FileReader(); // CREATE AN NEW INSTANCE.

                reader.onload = function (e) {
                    var img = new Image();
                    img.src = e.target.result;

                    img.onload = function () {
                        var w = this.width;
                        var h = this.height;

                        document.getElementById('fileInfo').innerHTML =
                            document.getElementById('fileInfo').innerHTML + '<br /> ' +
                                'Name: <b>' + file.name + '</b> <br />' +
                                'File Extension: <b>' + fileExtension + '</b> <br />' +
                                'Size: <b>' + Math.round((file.size / 1024)) + '</b> KB <br />' +
                                'Width: <b>' + w + '</b> <br />' +
                                'Height: <b>' + h + '</b> <br />' +
                                'Type: <b>' + file.type + '</b> <br />' +
                                'Last Modified: <b>' + file.lastModifiedDate + '</b> <br />';
                    }
                };
                reader.readAsDataURL(file);
            }
        }
    }
var canvas = document.getElementById("can");
var loadingimage = null;
var gsimage = null;
var redimage = null;
var blueimage = null;
var rainbowimage = null;

function loadImage(){
  var fileinput = document.getElementById("finput");
  loadingimage =
    new SimpleImage(fileinput);
  gsimage =
    new SimpleImage(fileinput);
  redimage =
    new SimpleImage(fileinput);
  blueimage =
    new SimpleImage(fileinput);
  rainbowimage =
    new SimpleImage(fileinput);
  loadingimage.drawTo(canvas);
}

function makeGrayscale(){
  for (var pixel of gsimage.values())     {
  var r = pixel.getRed();
  var g = pixel.getGreen();
  var b = pixel.getBlue();
  var avg = ((r + g + b) / 3);
  pixel.setRed(avg);
  pixel.setGreen(avg);
  pixel.setBlue(avg);
  }
}

function doGray(){
  if ( imageIsLoaded(gsimage) ){
    makeGrayscale();
    gsimage.drawTo(canvas);
  }
}

function makeRed(){
  for (var pixel of redimage.values())     {
  var r = pixel.getRed();
  var g = pixel.getGreen();
  var b = pixel.getBlue();
  var avg = ((r + g + b) / 3);
    if (avg < 128)
    {
    pixel.setRed(2 * avg);
    pixel.setGreen(0);
    pixel.setBlue(0);
    }
    else
    {
    pixel.setRed(255);
    pixel.setGreen(2 * avg - 255);
    pixel.setBlue(2 * avg - 255);
    }
  }
}

function doRed(){
  if ( imageIsLoaded(redimage) ){
    makeRed();
    redimage.drawTo(canvas);
  }
}

function makeBlue(){
  for (var pixel of blueimage.values())   {
  var r = pixel.getRed();
  var g = pixel.getGreen();
  var b = pixel.getBlue();
  var avg = ((r + g + b) / 3);
    if (avg < 128)
      {
      pixel.setRed(0);
      pixel.setGreen(0);
      pixel.setBlue(2 * avg);
      }
      else
      {
      pixel.setRed(0);
      pixel.setGreen(2*avg-255);
      pixel.setBlue(255);
      }
  }
}


function doBlue(){
  if ( imageIsLoaded(blueimage) ){
    makeBlue();
    blueimage.drawTo(canvas);
  }
}

function makeRainbow(rainbowimage){
  var img_height = rainbowimage.getHeight();
  for (var pixel of rainbowimage.values())
  {
  var pix_Y = pixel.getY();
  var r = pixel.getRed();
  var g = pixel.getGreen();
  var b = pixel.getBlue();
  var avg = ((r + g + b) / 3);
    if (pix_Y < (img_height / 7))
      { // red
        if (avg < 128)
          {
          pixel.setRed(2 * avg);
          pixel.setGreen(0);
          pixel.setBlue(0);
          }
          else
          {
          pixel.setRed(255);
          pixel.setGreen(2*avg-255);
          pixel.setBlue(2*avg-255);
          }
      }
      else if (pix_Y <(img_height*2/7))
        { // orange
          if (avg < 128)
          {
          pixel.setRed(2 * avg);
          pixel.setGreen(0.8 * avg);
          pixel.setBlue(0);
          }
          else
          {
          pixel.setRed(255);
          pixel.setGreen(1.2*avg-51);
          pixel.setBlue(2*avg-255);
          }
        }
      else if (pix_Y <(img_height*3/7))
        { // yellow
          if (avg < 128)
          {
          pixel.setRed(2 * avg);
          pixel.setGreen(1.7 * avg);
          pixel.setBlue(0);
          }
          else
          {
          pixel.setRed(255);
          pixel.setGreen(255);
          pixel.setBlue(0);
          }
        }
      else if (pix_Y <(img_height*4/7))
        { // green
          if (avg < 128)
          {
          pixel.setRed(0);
          pixel.setGreen(1.8 * avg);
          pixel.setBlue(0);
          }
          else
          {
          pixel.setRed(2 * avg - 255);
          pixel.setGreen(255);
          pixel.setBlue(2 * avg - 255);
          }
      }
      else if (pix_Y <(img_height*5/7))
        { // blue
          if (avg < 128)
          {
          pixel.setRed(0);
          pixel.setGreen(0);
          pixel.setBlue(2 * avg);
          }
          else
          {
          pixel.setRed(0);
          pixel.setGreen(2*avg-255);
          pixel.setBlue(255);
          }
        }
      else if (pix_Y <(img_height*6/7))
        { // indigo
          if (avg < 128)
          {
          pixel.setRed(0.6 * avg);
          pixel.setGreen(0);
          pixel.setBlue(2 * avg);
          }
          else
          {
          pixel.setRed(1.4*avg-102);
          pixel.setGreen(2*avg-255);
          pixel.setBlue(255);
          }
        }
      else if (pix_Y <(img_height*7/7))
        { // violet
          if (avg < 128)
          {
          pixel.setRed(1.6 * avg);
          pixel.setGreen(0);
          pixel.setBlue(1.6 * avg);
          }
          else
          {
          pixel.setRed(0.4*avg+153);
          pixel.setGreen(2*avg-255);
          pixel.setBlue(0.4*avg+153);
          }
     }
  }
}

function doRainbow(){
  if ( imageIsLoaded(rainbowimage) ){
    makeRainbow(rainbowimage);
    rainbowimage.drawTo(canvas);
  }
}

function makeReset(){
  if ( imageIsLoaded(loadingimage) ){
    loadingimage.drawTo(canvas);
  gsimage =
    new SimpleImage(loadingimage);
  redimage =
    new SimpleImage(loadingimage);
  blueimage =
    new SimpleImage(loadingimage);
  rainbowimage =
    new SimpleImage(loadingimage);
  }
}

function imageIsLoaded(img){
  if (img == null || !img.complete()) {
    alert('Image is not loaded');
    return false;
  }
  else
    {
    return true;
    }
}


console.clear();

let sources = [
  { name: 'Girl with a Pearl Earring', url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d7/Meisje_met_de_parel.jpg/300px-Meisje_met_de_parel.jpg' },
];

let c = document.getElementById('c');
let ctx = c.getContext('2d');
let size = { x: c.width, y: c.height };
let definition = 100;
let partSize = size.y / definition;
let picData = [];
let points = [];

async function load(data) {
  if (data instanceof File) {
    return new Promise((res, rej) => {
      let reader = new FileReader();
      reader.onload = () => res(load(reader.result));
      reader.onerror = rej;
      reader.readAsDataURL(data);
    });
  }
  return new Promise((res, rej) => {
    let img = new Image();
    img.onload = () => res(img);
    img.onerror = rej;
    img.crossOrigin = 'anonymous';
    img.src = data;
  });
}
function getLightData(image, size) {
  if (!size) {
    size = { x: img.width, y: img.height };
  }
  let c = document.createElement('canvas');
  let ctx = c.getContext('2d');
  c.width = size.x;
  c.height = size.y;
  ctx.fillRect(0, 0, c.width, c.height);
  let w = size.x;
  let h = size.y;
  let imgRatio = image.width / image.height;
  let finalRatio = w / h;
  if (imgRatio > finalRatio) {
    w = h * imgRatio;
  } else {
    h = w / imgRatio;
  }
  ctx.drawImage(image, (size.x - w) * .5, (size.y - h) * .5, w, h);
  let data = ctx.getImageData(0, 0, size.x, size.y).data;
  let ret = [];
  for (let i = 0, n = data.length; i < n; i += 4) {
    ret.push((.2126 * data[i] + .7152 * data[i + 1] + .0722 * data[i + 2]) / 255);
  }
  return ret;
}
let currentImage = null;
async function prepare(source) {
  if (source === currentImage) {
    return;
  }
  currentImage = source;
  picData = [];
  let image = await load(source);
  if (currentImage !== source) {
    return;
  }
  picData = getLightData(image, size);
}

function at(x, y) {
  return picData[~~x + ~~y * size.x] || 0;
}
function addLine() {
  points.push(...[...Array(definition)].map((e, i) => ({ x:0, y: i * partSize })));
}

let spawner = (() => {
  let last = 0;
  // interval in seconds
  let interval = .3;
  return {
    setInterval: v => interval = v || 1,
    tick: dt => {
      last += dt || 0;
      if (last >= interval) {
        addLine();
        last = last % interval;
      }
    }
  };
})();

let speed = 100;
let minSpeed = .15;

// Under 30fps, prefer lagging than time accuracy
let maxDT = 1 / 30;
let previous;
function loop(timestamp) {
  if (!previous) {
    previous = timestamp;
  }
  let dt = (timestamp - previous) * .001;
  if (dt > maxDT) {
    dt = maxDT;
  }
  previous = timestamp;
  spawner.tick(dt);
  ctx.fillStyle = '#34495e';
  ctx.fillRect(0, 0, size.x, size.y);
  ctx.fillStyle = '#fff';
  for (let i = points.length; i--;) {
    let point = points[i];
    let val = 1 - at(point.x, point.y);
    let factor = minSpeed + (1 - minSpeed) * (val * val);
    point.x += speed * dt * factor;
    if (point.x >= size.x || point.x < 0 || point.y >= size.y || point.y < 0) {
      points.splice(i, 1);
      continue;
    }
    ctx.fillRect(point.x, point.y, 1, partSize);
  }
  requestAnimationFrame(loop);
}

document.getElementById('interval').addEventListener('input', e => {
  spawner.setInterval(e.target.value / 1000);
});
document.getElementById('speed').addEventListener('input', e => {
  speed = +e.target.value;
});
document.getElementById('sf').addEventListener('input', e => {
  minSpeed = e.target.value / 100;
});

function checkSize() {
  let size = Math.min(window.innerWidth, window.innerHeight, c.width);
  c.style.width = size + 'px';
  c.style.height = size + 'px';
}
window.addEventListener('resize', checkSize);

c.addEventListener('click', () => {
  c.style.zIndex = c.style.zIndex ? '' : 5;
});

let $selection = document.querySelector('.selection');
sources.forEach(source => {
  let button = document.createElement('button');
  button.textContent = source.name;
  button.addEventListener('click', () => prepare(source.url));
  $selection.insertBefore(button, $selection.lastElementChild);
});
document.getElementById('custom').addEventListener('change', e => {
  let files = e.target.files;
  let file = files && files[0];
  if (!file) {
    return;
  }
  prepare(file);
});
document.body.addEventListener('dragover', e => e.preventDefault());
document.body.addEventListener('drop', e => {
  e.preventDefault();
  let dt = e.dataTransfer;
  if (dt.items) {
    let file = [...dt.items].find(e => e.kind === 'file');
    if (file) {
      prepare(file.getAsFile());
    }
  } else {
    let file = dt.files[0];
    if (file) {
      prepare(file);
    }
  }
});

checkSize();
prepare(sources[0].url).then(() => requestAnimationFrame(loop));
</script>

</html>
